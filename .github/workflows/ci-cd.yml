name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:

jobs:
  # === CI PHASE ===
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---- Backend: Laravel ----
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2

      - name: Install Composer dependencies
        run: |
          cd backend
          composer install --no-interaction --prefer-dist --no-progress

      - name: Run Laravel tests
        run: |
          cd backend
          php artisan test

      # ---- Frontend: React ----
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'  # cache npm để build nhanh hơn

      - name: Install Node dependencies
        run: |
          cd frontend
          npm ci   # dùng npm ci để đảm bảo build reproducible và sạch

      - name: Run ESLint
        run: |
          cd frontend
          npm run lint

      - name: Build React app
        run: |
          cd frontend
          npm run build

  docker:
    runs-on: ubuntu-latest
    needs: ci
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker images
        run: |
          docker compose build

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push images
        run: docker compose push

  # === CD PHASE ===
  deploy-backend:
    runs-on: ubuntu-latest
    needs: docker
    steps:
      - name: Trigger Render deploy
        run: |
          curl -X POST https://api.render.com/deploy/srv-xxxxxx?key=${{ secrets.RENDER_API_KEY }}

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: ci
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        run: |
          npm i -g vercel
          cd frontend
          vercel --prod --token ${{ secrets.VERCEL_TOKEN }}

  notify:
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()
    steps:
      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "CI/CD result for ${{ github.repository }}"
          to: "yourmail@example.com"
          from: "GitHub Actions <${{ secrets.EMAIL_USER }}>"
          body: |
            Status: ${{ job.status }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
